<!DOCTYPE html>
<html>
<head>
  <title>Subhranil's Live Safety Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-weight: bold; }
    #map { height: calc(100vh - 50px); width: 100%; }
  </style>
</head>
<body>
  <div id="header">üìç LIVE TRACKER: ON-DUTY</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize map centered on India
    var map = L.map('map').setView([22.5726, 88.3639], 15); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var marker = L.marker([0,0]).addTo(map).bindPopup("Waiting for GPS...");

    // Your Specific Adafruit IO Config
    const username = "subhranil20219079";
    const aioKey = "aio_TNPC929chihuismCyKI8bGKwh21t";
    const feedKey = "gps-location"; 

    async function fetchData() {
      try {
        // Fetch the last data point from your combined feed
        let resp = await fetch(`https://io.adafruit.com/api/v2/${username}/feeds/${feedKey}/data/last?X-AIO-Key=${aioKey}`);
        let json = await resp.json();
        
        // Data format is "0,lat,lon,0" - we need to split it by the comma
        let parts = json.value.split(',');
        let lat = parseFloat(parts[1]);
        let lon = parseFloat(parts[2]);

        if(!isNaN(lat) && !isNaN(lon)) {
          let newPos = [lat, lon];
          marker.setLatLng(newPos);
          map.panTo(newPos);
          marker.getPopup().setContent(`<b>Live Location</b><br>Lat: ${lat}<br>Lon: ${lon}`).openOn(map);
        }
      } catch(err) {
        console.error("Connection Error:", err);
      }
    }

    // Update every 5 seconds
    setInterval(fetchData, 5000);
    fetchData(); 
  </script>
</body>
</html>